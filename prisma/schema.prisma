generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Cpu {
  id                    String          @id @default(cuid())
  name                  String          @unique
  slug                  String          @unique
  brand                 String
  cores                 Int
  threads               Int
  baseClock             Float
  boostClock            Float?
  socket                String
  hasIntegratedGraphics Boolean         @default(false)
  tdp                   Int?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  bestPriceCents        Int?
  worstPriceCents       Int?
  offerScore            Float?
  lastPriceCheck        DateTime?
  offers                Offer[]
  alerts                PriceAlert[]
  priceSnapshots        PriceSnapshot[]
}

model Store {
  id                    String                 @id @default(cuid())
  name                  String                 @unique
  url                   String
  createdAt             DateTime               @default(now())
  offers                Offer[]
  priceSnapshots        PriceSnapshot[]
  productOffers         ProductOffer[]
  productPriceSnapshots ProductPriceSnapshot[]
}

model Offer {
  id         String   @id @default(cuid())
  cpuId      String
  storeId    String
  priceCents Int
  url        String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  cpu        Cpu      @relation(fields: [cpuId], references: [id])
  store      Store    @relation(fields: [storeId], references: [id])
}

model PriceSnapshot {
  id         String   @id @default(cuid())
  cpuId      String
  storeId    String
  priceCents Int
  date       DateTime
  createdAt  DateTime @default(now())
  cpu        Cpu      @relation(fields: [cpuId], references: [id])
  store      Store    @relation(fields: [storeId], references: [id])

  @@unique([cpuId, storeId, date])
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  username     String?      @unique
  passwordHash String?
  name         String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  accounts     Account[]
  favorites    Favorite[]
  alerts       PriceAlert[]
  sessions     Session[]
}

model PriceAlert {
  id               String            @id @default(cuid())
  userId           String
  
  // Campos polimórficos para suportar CPU/GPU/MOTHERBOARD
  itemType         AlertItemType     @default(CPU)
  itemId           String
  
  // Compatibilidade legada com alertas antigos de CPU
  cpuId            String?
  
  targetPriceCents Int
  isActive         Boolean           @default(true)
  triggeredAt      DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  // ✅ CORREÇÃO: Relação opcional porque cpuId é opcional
  cpu              Cpu?              @relation(fields: [cpuId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  events           PriceAlertEvent[]

  @@index([userId, isActive])
  @@index([cpuId, isActive])
  @@index([itemType, itemId, isActive])
}

model PriceAlertEvent {
  id         String     @id @default(cuid())
  alertId    String
  priceCents Int
  storeName  String?
  createdAt  DateTime   @default(now())
  alert      PriceAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@index([alertId, createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Favorite {
  id        String           @id @default(cuid())
  userId    String
  itemType  FavoriteItemType
  itemId    String
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType, itemId])
  @@index([userId, itemType])
}

model Product {
  id              String                 @id @default(cuid())
  type            ProductType
  name            String
  slug            String                 @unique
  brand           String
  specsJson       Json
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  bestPriceCents  Int?
  worstPriceCents Int?
  offerScore      Float?
  lastPriceCheck  DateTime?
  gpu             Gpu?
  motherboard     Motherboard?
  offers          ProductOffer[]
  priceSnapshots  ProductPriceSnapshot[]

  @@unique([type, name])
  @@index([type, brand])
}

model ProductOffer {
  id           String   @id @default(cuid())
  productId    String
  storeId      String
  priceCents   Int
  url          String
  affiliateUrl String?
  stockStatus  String   @default("available")
  lastSeenAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id])
  store        Store    @relation(fields: [storeId], references: [id])
}

model ProductPriceSnapshot {
  id         String   @id @default(cuid())
  productId  String
  storeId    String
  priceCents Int
  date       DateTime
  createdAt  DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id])
  store      Store    @relation(fields: [storeId], references: [id])

  @@unique([productId, storeId, date])
}

model Gpu {
  id         String   @id @default(cuid())
  productId  String   @unique
  vramGb     Int
  vramType   String
  baseClock  Int
  boostClock Int?
  tdp        Int
  interface  String
  chipset    String?
  createdAt  DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Motherboard {
  id          String   @id @default(cuid())
  productId   String   @unique
  chipset     String
  socket      String
  formFactor  String
  ramSlots    Int
  ramType     String
  maxRamGb    Int
  maxRamSpeed Int?
  wifi        Boolean  @default(false)
  sataPorts   Int
  m2Slots     Int
  usbPorts    Json
  createdAt   DateTime @default(now())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// ✅ NOVO: Enum específico para alertas de preço
enum AlertItemType {
  CPU
  GPU
  MOTHERBOARD
}

enum FavoriteItemType {
  CPU
  GPU
  MOTHERBOARD
}

enum ProductType {
  GPU
  MOTHERBOARD
}